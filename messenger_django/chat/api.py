"""
ูุฐุง ุงูููุฏ ููุถุญ ููููุฉ ุฅูุดุงุก ูุฌููุนุฉ ูู ูุงุฌูุงุช ุจุฑูุฌุฉ ุงูุชุทุจููุงุช (APIs) ููุชุนุงูู ูุน ุงููุญุงุฏุซุงุช ูุงูุฑุณุงุฆู ุจุงุณุชุฎุฏุงู Django REST Framework. ุฅููู ุดุฑุญูุง ุชูุตููููุง ููู ุฏุงูุฉ ููุง ุชููู ุจู:

1. ุฏุงูุฉ conversation_list
ุงููุฏู: ุนุฑุถ ุฌููุน ุงููุญุงุฏุซุงุช ุงูุชู ูุดุงุฑู ูููุง ุงููุณุชุฎุฏู ุงูุญุงูู.
ุงูุฎุทูุงุช:
ุชุตููุฉ ุงููุญุงุฏุซุงุช ุงูุชู ุชุญุชูู ุนูู ุงููุณุชุฎุฏู ุงูุญุงูู ุจุงุณุชุฎุฏุงู filter(users__in=list([request.user])).
ุชุญููู ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู ConversationSerializer.
ุฅุฑุฌุงุน ุงูุจูุงูุงุช ุจุดูู JSON ุฅูู ุงูุนููู ุจุงุณุชุฎุฏุงู JsonResponse.
2. ุฏุงูุฉ conversation_detail
ุงููุฏู: ุนุฑุถ ุชูุงุตูู ูุญุงุฏุซุฉ ูุนููุฉ ุจูุงุกู ุนูู ูุนุฑู ุงููุญุงุฏุซุฉ (pk).
ุงูุฎุทูุงุช:
ุฌูุจ ุงููุญุงุฏุซุฉ ุจุงุณุชุฎุฏุงู get(pk=pk) ูุชุตููุฉ ุงููุญุงุฏุซุงุช ุงูุชู ุชุญุชูู ุนูู ุงููุณุชุฎุฏู ุงูุญุงูู.
ุชุญููู ุจูุงูุงุช ุงููุญุงุฏุซุฉ ุจุงุณุชุฎุฏุงู ConversationDetailSerializer.
ุฅุฑุณุงู ุงูุชูุงุตูู ุจุดูู JSON ุฅูู ุงูุนููู.
3. ุฏุงูุฉ conversation_get_or_create
ุงููุฏู: ุฌูุจ ูุญุงุฏุซุฉ ุจูู ุงููุณุชุฎุฏู ุงูุญุงูู ููุณุชุฎุฏู ุขุฎุฑ ูุนูู ุฃู ุฅูุดุงุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ.
ุงูุฎุทูุงุช:
ุฌูุจ ุงููุณุชุฎุฏู ุงูุขุฎุฑ ุจุงุณุชุฎุฏุงู User.objects.get(pk=user_pk).
ุชุตููุฉ ุงููุญุงุฏุซุงุช ุงูุชู ุชุถู ููุง ุงููุณุชุฎุฏููู.
ุฅุฐุง ูุงูุช ุงููุญุงุฏุซุฉ ููุฌูุฏุฉุ ูุชู ุงุณุชุฎุฏุงู ุฃูู ูุญุงุฏุซุฉ ููุฌูุฏุฉ. ูุฅุฐุง ูู ุชูู ููุฌูุฏุฉุ ูุชู ุฅูุดุงุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ ูุฅุถุงูุฉ ุงููุณุชุฎุฏููู ุฅูููุง.
ุชุญููู ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู ConversationDetailSerializer ูุฅุฑุณุงููุง ุจุดูู JSON.
4. ุฏุงูุฉ conversation_send_message
ุงููุฏู: ุฅุฑุณุงู ุฑุณุงูุฉ ุฏุงุฎู ูุญุงุฏุซุฉ ูุญุฏุฏุฉ.
ุงูุฎุทูุงุช:
ุฌูุจ ุงููุญุงุฏุซุฉ ุจุงุณุชุฎุฏุงู get(pk=pk) ูุงูุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ุงูุญุงูู ุฌุฒุก ูู ุงููุญุงุฏุซุฉ.
ุชุญุฏูุฏ ุงููุณุชุฎุฏู ุงููุณุชูู ููุฑุณุงูุฉ.
ุฅูุดุงุก ุฑุณุงูุฉ ุฌุฏูุฏุฉ ุจุงุณุชุฎุฏุงู ConversationMessage.objects.create.
ุชุญููู ุงูุฑุณุงูุฉ ุจุงุณุชุฎุฏุงู ConversationMessageSerializer ูุฅุฑุฌุงุนูุง ุจุดูู JSON.
ููุงุญุธุงุช ุฅุถุงููุฉ:
ุงูุฏูููุฑ @api_view(["GET"]): ูุญุฏุฏ ุฃู ุงูุฏุงูุฉ ูู API ูุชุฏุนู ุทุฑููุฉ GET (ูููู ุฃูุถูุง ุฃู ุชุฏุนู POST ุฃู ุบูุฑูุง).
JsonResponse: ูุณุชุฎุฏู ูุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู ุงูุนููู ูู ุดูู JSON.
ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก: ูู ุชุชู ูุนุงูุฌุฉ ุญุงูุงุช ุงูุฎุทุฃ ูุซู ุนุฏู ุงูุนุซูุฑ ุนูู ูุณุชุฎุฏู ุฃู ูุญุงุฏุซุฉุ ูููุถู ุฅุถุงูุฉ ุงุณุชุซูุงุกุงุช ููุชุญูู ูู ุงูุฃุฎุทุงุก ูุซู DoesNotExist.
ุชุญุณููุงุช ูุญุชููุฉ:
ุฅุถุงูุฉ ูุตุงุฏูุฉ (authentication_classes) ูุตูุงุญูุงุช (permission_classes) ูุถูุงู ุฃู ุงููุณุชุฎุฏููู ูุตุฑุญ ููู ุจุงููุตูู ุฅูู ูุฐู ุงูุฏูุงู.
ุงูุชุนุงูู ูุน ุญุงูุงุช ุงูุฎุทุฃ ุจุงุณุชุฎุฏุงู try-except ูุฅุฑุฌุงุน ุงุณุชุฌุงุจุงุช ููุงุณุจุฉ ูุซู Http404 ุฃู ุงุณุชุฌุงุจุฉ ุฎุทุฃ ูุฎุตุตุฉ.
ูุฐุง ุงูููุฏ ูููุฑ ุจููุฉ ูุฑูุฉ ูุณููุฉ ููุชุนุงูู ูุน ุงููุญุงุฏุซุงุช ูุงูุฑุณุงุฆู ูู ุชุทุจููุงุช ุงูุฏุฑุฏุดุฉ ุจุงุณุชุฎุฏุงู Django REST Framework.

"""

from django.http import JsonResponse

# ๐ ูุชุญุฏูุฏ ุฃู ูุฐู ุงูุฏุงูุฉ ูู API view
# ๐ ูุชุญุฏูุฏ ุงูููุงุณุงุช ุงููุณุคููุฉ ุนู ุงููุตุงุฏูุฉ
# ๐ ูุชุญุฏูุฏ ุงูููุงุณุงุช ุงููุณุคููุฉ ุนู ุงูุตูุงุญูุงุช
from rest_framework.decorators import (
    api_view,
    authentication_classes,
    permission_classes,
)

# ๐ค ุงุณุชูุฑุงุฏ ูููุฐุฌ ุงููุณุชุฎุฏู ูู ุงูุชุทุจูู
from account.models import User

# ๐ฌ ุงุณุชูุฑุงุฏ ุงูููุงุฐุฌ ุงูุฎุงุตุฉ ุจุงููุญุงุฏุซุงุช ูุงูุฑุณุงุฆู
from .models import (
    Conversation,
    ConversationMessage,
)

# ๐งฉ ุชุนุฑูู ุงูุณูุฑูุงูุงูุฒุฑ ูููุญุงุฏุซุงุช
# ๐ ุณูุฑูุงูุงูุฒุฑ ูุนุฑุถ ุชูุงุตูู ุงููุญุงุฏุซุฉ
# ๐ ุณูุฑูุงูุงูุฒุฑ ูุนุฑุถ ุชูุงุตูู ุงูุฑุณุงุฆู
from .serializers import (
    ConversationSerializer,
    ConversationDetailSerializer,
    ConversationMessageSerializer,
)


# ๐ ูุฐุง ุงูุฏูููุฑ ูุชู ุชุทุจููู ูุชุญุฏูุฏ ุฃู ูุฐู ุฏุงูุฉ GET API
# ๐ ุฏุงูุฉ ูุนุฑุถ ุฌููุน ุงููุญุงุฏุซุงุช ุงูุฎุงุตุฉ ุจุงููุณุชุฎุฏู
@api_view(["GET"])
def conversation_list(request):
    # ๐ง ุชุตููุฉ ุงููุญุงุฏุซุงุช ุงูุชู ุชุถู ุงููุณุชุฎุฏู ุงูุญุงูู
    conversations = Conversation.objects.filter(users__in=list([request.user]))
    # ๐งฉ ุชุญููู ุงูุจูุงูุงุช ุฅูู ุงูุดูู ุงูููุงุณุจ
    serializer = ConversationSerializer(conversations, many=True)

    # ๐ก ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู ุงูุนููู ูู ุดูู JSON
    return JsonResponse(serializer.data, safe=False)


# ๐ ุฏุงูุฉ ูุนุฑุถ ุชูุงุตูู ูุญุงุฏุซุฉ ูุนููุฉ
# ๐ ุชุญุฏูุฏ ุงููุญุงุฏุซุฉ ุจุงุณุชุฎุฏุงู ุงูู pk
@api_view(["GET"])
def conversation_detail(request, pk):
    # ๐ต๏ธโโ๏ธ ุฌูุจ ุงููุญุงุฏุซุฉ ุจุงุณุชุฎุฏุงู ุงูู pk
    conversation = Conversation.objects.filter(users__in=list([request.user])).get(
        pk=pk
    )
    # ๐ ุชุญููู ุจูุงูุงุช ุงููุญุงุฏุซุฉ ุฅูู ุงูุดูู ุงูููุงุณุจ
    serializer = ConversationDetailSerializer(conversation)

    # ๐ก ุฅุฑุณุงู ุงูุชูุงุตูู ุฅูู ุงูุนููู
    return JsonResponse(serializer.data, safe=False)


# ๐ ุฏุงูุฉ ููุญุตูู ุนูู ูุญุงุฏุซุฉ ุฃู ุฅูุดุงุฆูุง ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
# ๐ค ุงููุณุชุฎุฏู ุงููุณุชูุฏู ุงูุฐู ุณูุชุญูู ูู ูุฌูุฏ ูุญุงุฏุซุฉ ูุนู
@api_view(["GET"])
def conversation_get_or_create(request, user_pk):
    # ๐ ุฌูุจ ุงููุณุชุฎุฏู ุงููุณุชูุฏู ุจุงุณุชุฎุฏุงู ุงูู pk
    user = User.objects.get(pk=user_pk)

    # ๐ง ุชุตููุฉ ุงููุญุงุฏุซุงุช ุงูุชู ุชุถู ุงููุณุชุฎุฏููู
    conversations = Conversation.objects.filter(users__in=list([request.user])).filter(
        users__in=list([user])
    )

    # โ ุฅุฐุง ูุงูุช ุงููุญุงุฏุซุฉ ููุฌูุฏุฉ
    if conversations.exists():
        # ๐ ุฃุฎุฐ ุฃูู ูุญุงุฏุซุฉ ููุฌูุฏุฉ
        conversation = conversations.first()
    # ๐ซ ุฅุฐุง ูู ุชูู ุงููุญุงุฏุซุฉ ููุฌูุฏุฉ
    else:
        # ๐ ุฅูุดุงุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ
        conversation = Conversation.objects.create()
        # ๐ฅ ุฅุถุงูุฉ ุงููุณุชุฎุฏููู ุฅูู ุงููุญุงุฏุซุฉ
        conversation.users.add(user, request.user)
        # ๐พ ุญูุธ ุงููุญุงุฏุซุฉ ุงูุฌุฏูุฏุฉ
        conversation.save()

    # ๐งฉ ุชุญููู ุงูุจูุงูุงุช ุฅูู ุงูุดูู ุงูููุงุณุจ
    serializer = ConversationDetailSerializer(conversation)

    # ๐ก ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู ุงูุนููู
    return JsonResponse(serializer.data, safe=False)


# ๐ ุฏุงูุฉ ูุฅุฑุณุงู ุฑุณุงูุฉ ุฏุงุฎู ุงููุญุงุฏุซุฉ
# ๐ฌ ุฅุฑุณุงู ุฑุณุงูุฉ ุฅูู ุงููุญุงุฏุซุฉ ุงููุญุฏุฏุฉ
@api_view(["POST"])
def conversation_send_message(request, pk):
    # ๐ต๏ธโโ๏ธ ุฌูุจ ุงููุญุงุฏุซุฉ ุจุงุณุชุฎุฏุงู ุงูู pk
    conversation = Conversation.objects.filter(users__in=list([request.user])).get(
        pk=pk
    )

    # ๐ฅ ุงูุชุญูู ูู ุฌููุน ุงููุณุชุฎุฏููู ูู ุงููุญุงุฏุซุฉ
    for user in conversation.users.all():
        # โ ุงุณุชุจุนุงุฏ ุงููุณุชุฎุฏู ุงูุญุงูู
        if user != request.user:
            # ๐ค ุชุญุฏูุฏ ุงููุณุชูู
            sent_to = user

    conversation_message = ConversationMessage.objects.create(
        # โ๏ธ ุฅูุดุงุก ุงูุฑุณุงูุฉ
        conversation=conversation,
        # ๐ ุฌูุจ ูุต ุงูุฑุณุงูุฉ ูู ุงูุจูุงูุงุช ุงููุฏุฎูุฉ
        body=request.data.get("body"),
        # ๐๏ธ ุชุญุฏูุฏ ูู ุฃูุดุฃ ุงูุฑุณุงูุฉ
        created_by=request.user,
        # ๐ฌ ุชุญุฏูุฏ ูู ุฃูุฑุณูุช ุฅููู ุงูุฑุณุงูุฉ
        sent_to=sent_to,
    )

    # ๐งฉ ุชุญููู ุงูุจูุงูุงุช ุฅูู ุงูุดูู ุงูููุงุณุจ
    serializer = ConversationMessageSerializer(conversation_message)

    # ๐ก ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุฅูู ุงูุนููู
    return JsonResponse(serializer.data, safe=False)
